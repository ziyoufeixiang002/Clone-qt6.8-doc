name: Clone Android API Documentation

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼ˆæ¨èï¼‰
  # schedule:
  #   - cron: '0 2 * * 0'  # æ¯å‘¨æ—¥ 2 ç‚¹è‡ªåŠ¨æ›´æ–°ï¼ˆå–æ¶ˆæ³¨é‡Šå‰è¯·ç¡®è®¤éµå®ˆ robots.txtï¼‰

jobs:
  clone-android-docs:
    runs-on: ubuntu-latest
    env:
      TARGET_URL: "https://developer.android.com/reference"
      DOWNLOAD_DIR: "android-doc"
      OUTPUT_ARCHIVE: "android-doc.zst"

    steps:
      - name: ğŸ› ï¸ Checkout Repository (optional, for debugging)
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget zstd ca-certificates

      - name: ğŸ“ Create Download Directory
        run: mkdir -p "$DOWNLOAD_DIR"

      - name: ğŸŒ Download Android API Docs (International Site)
        run: |
          wget \
            --recursive \
            --level=10 \
            --no-clobber \
            --page-requisites \
            --convert-links \
            --html-extension \
            --restrict-file-names=ascii \
            --domains=developer.android.com \
            --no-parent \
            --execute robots=off \
            --wait=1 \
            --random-wait \
            --timeout=30 \
            --tries=3 \
            --user-agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
            --header="Accept-Language: en-US,en;q=0.9" \
            --accept-regex '\.(html?|css|js|txt|json|xml|svg|png|jpg|jpeg|gif|ico|woff2?|ttf|otf)$' \
            --reject-regex '\.(mp[34]|avi|mov|wmv|flv|webm|wav|ogg|zip|rar|tar|gz|bz2|xz|7z|iso|dmg|exe|msi|apk|bin|deb|rpm|pdf)$' \
            --directory-prefix="$DOWNLOAD_DIR" \
            "$TARGET_URL"
        continue-on-error: true  # å…è®¸ä¸ªåˆ« 403/404 ä¸ä¸­æ–­

      - name: ğŸ§¹ Clean Up Query-String Files
        run: |
          find "$DOWNLOAD_DIR" -type f -name "*\?*" -delete 2>/dev/null || true

      - name: ğŸ“Š Verify Downloaded Content
        run: |
          total_files=$(find "$DOWNLOAD_DIR" -type f | wc -l)
          html_files=$(find "$DOWNLOAD_DIR" -name "*.html" | wc -l)
          echo "âœ… Total files: $total_files"
          echo "âœ… HTML files: $html_files"
          if [ "$html_files" -lt 100 ]; then
            echo "âŒ Warning: Fewer than 100 HTML files found. Recursion may have failed."
            # åˆ—å‡ºéƒ¨åˆ†æ–‡ä»¶ç”¨äºè°ƒè¯•
            find "$DOWNLOAD_DIR" -name "*.html" | head -n 10
          fi

      - name: ğŸ“¦ Compress Documentation
        run: |
          if [ ! -d "$DOWNLOAD_DIR" ] || [ -z "$(ls -A "$DOWNLOAD_DIR")" ]; then
            echo "âŒ Download directory is empty!"
            exit 1
          fi
          tar -I 'zstd -T0 --long' -cf "$OUTPUT_ARCHIVE" "$DOWNLOAD_DIR"

      - name: ğŸ“¤ Upload as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-api-docs
          path: ${{ env.OUTPUT_ARCHIVE }}
          retention-days: 14
          compression-level: 0  # å·²é¢„å‹ç¼©

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          rm -rf "$DOWNLOAD_DIR" "$OUTPUT_ARCHIVE"
