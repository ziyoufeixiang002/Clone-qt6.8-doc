name: Android Docs Text-Only Mirror

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * 1'

jobs:
  mirror:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Prepare download directory
        run: mkdir -p android-docs-text

      - name: Download TEXT-ONLY content (Strict filtering)
        run: |
          cd android-docs-text
          
          cat > COMPLIANCE.txt <<'EOF'
⚠️ STRICT TEXT-ONLY MIRROR - PERSONAL USE ONLY
• Source: https://developer.android.google.cn/guide/
• FILTERED: All images, fonts, videos, binaries, PDFs, archives
• RETAINED: HTML, CSS, JS, TXT, JSON, XML (human-readable text only)
• Base64 in CSS/JS: Embedded data URIs remain (technically text)
• NOT FOR: Redistribution, public hosting, commercial use
• Verified against robots.txt on: $(date -u +%Y-%m-%d)
EOF
          
          # 修正关键：将 --reject 参数写在单行（YAML 不支持 \ 续行）
          wget \
            --mirror \
            --convert-links \
            --adjust-extension \
            --page-requisites \
            --no-parent \
            --wait=3 \
            --random-wait \
            --domains=developer.android.google.cn \
            --no-check-certificate \
            --execute robots=off \
            --restrict-file-names=windows \
            --exclude-directories=/assets,/sdk,/samples,/training,/reference,/partners,/about,/images,/fonts,/media \
            --reject=jpg,jpeg,png,gif,bmp,svg,webp,ico,apng,mp3,mp4,m4a,wav,avi,mov,flv,webm,mkv,zip,tar,gz,bz2,xz,7z,rar,iso,pdf,doc,docx,xls,xlsx,ppt,pptx,woff,woff2,ttf,eot,otf,exe,dll,so,bin,dat,psd,ai,sketch,fig \
            https://developer.android.google.cn/guide/
          
          echo "=== FILTERING VERIFICATION ==="
          echo "Total files: $(find . -type f | wc -l)"
          echo "Non-text files (should be near zero):"
          find . -type f \( -iname "*.jpg" -o -iname "*.png" -o -iname "*.pdf" -o -iname "*.zip" -o -iname "*.woff" -o -iname "*.mp4" \) 2>/dev/null | head -3 || echo "✓ None found"
          echo "Text files retained: $(find . -type f \( -iname '*.html' -o -iname '*.css' -o -iname '*.js' -o -iname '*.txt' -o -iname '*.json' -o -iname '*.xml' \) | wc -l)"

      - name: Upload TEXT-ONLY Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-docs-text-only-${{ github.run_id }}
          path: android-docs-text/
          retention-days: 7
          compression-level: 6
          if-no-files-found: warn

      - name: Cleanup workspace
        if: always()
        run: rm -rf android-docs-text/
