# .github/workflows/generic-site-mirror.yml
name: 'ğŸŒ é€šç”¨ç½‘ç«™é•œåƒå·¥ä½œæµ'

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'https://www.opendcl.com/HelpFiles/'
        required: true
        default: 'https://www.opendcl.com/HelpFiles/'
      wait_seconds:
        description: 'è¯·æ±‚é—´éš”ç§’æ•° (å»ºè®® â‰¥1)'
        required: false
        default: '1'
      retention_days:
        description: 'Artifact ä¿ç•™å¤©æ•° (1-90)'
        required: false
        default: '30'

jobs:
  mirror:
    runs-on: 'ubuntu-22.04'
    timeout-minutes: 90

    steps:
      - name: 'ğŸ”§ å®‰è£… wget2'
        run: |
          sudo apt-get update
          sudo apt-get install -y wget2 libnghttp2-14
          wget2 --version

      - name: 'ğŸŒ é•œåƒç½‘ç«™'
        env:
          TARGET_URL: '${{ github.event.inputs.target_url }}'
          WAIT_SECONDS: '${{ github.event.inputs.wait_seconds }}'
          # â—ï¸ã€ä¿®æ”¹æ­¤å¤„ 1/3ã€‘æ’é™¤è§„åˆ™ (æŒ‰éœ€è°ƒæ•´)
          # ä¿ç•™: HTML/CSS/JS/å›¾ç‰‡/å­—ä½“/JSON/XML
          # æ’é™¤: å¯æ‰§è¡Œæ–‡ä»¶/éŸ³è§†é¢‘/å‹ç¼©åŒ…/å®‰è£…åŒ…/å¤§å‹æ–‡æ¡£
          REJECT_REGEX: '\.(exe|dll|so|bin|msi|dmg|pkg|deb|rpm|apk|app|img|sh|run|jar|cab|msu|mp[34]|avi|mov|wmv|flv|wav|ogg|webm|m4a|aac|mkv|zip|rar|7z|tar|gz|bz2|xz|tgz|iso|php|asp|jsp|cfm|pdf|docx?|xlsx?|pptx?|psd|ai|ttf|otf)(\?[^#]*)?$'
          # â—ï¸ã€ä¿®æ”¹æ­¤å¤„ 2/3ã€‘è·¨åŸŸèµ„æºåŸŸå (é€—å·åˆ†éš”)
          DOMAINS: 'www.opendcl.com'
          # â—ï¸ã€ä¿®æ”¹æ­¤å¤„ 3/3ã€‘User-Agent (å¿…é¡»åŒ…å«è”ç³»æ–¹å¼)
          USER_AGENT: 'SiteMirrorBot/1.0 (+https://github.com/${{ github.repository }})'
        run: |
          echo "ğŸš€ å¼€å§‹é•œåƒ: $TARGET_URL"
          echo "â±ï¸  è¯·æ±‚é—´éš”: ${WAIT_SECONDS}ç§’"
          
          MIRROR_DIR="mirror-$(date +%Y%m%d-%H%M%S)"
          mkdir -p "$MIRROR_DIR"
          
          # æ‰§è¡Œ wget2 é•œåƒ
          wget2 \
            --mirror \
            --page-requisites \
            --convert-links \
            --adjust-extension \
            --span-hosts \
            --domains="$DOMAINS" \
            --ignore-case \
            --reject-regex="$REJECT_REGEX" \
            --wait="$WAIT_SECONDS" \
            --user-agent="$USER_AGENT" \
            --directory-prefix="$MIRROR_DIR" \
            --quiet \
            "$TARGET_URL" || echo "âš ï¸ é•œåƒå®Œæˆ (å«è­¦å‘Š)"
          
          # âœ… å®‰å…¨ç”Ÿæˆé…ç½®æŠ¥å‘Š (é¿å… here-document ç¼©è¿›é—®é¢˜)
          printf '%s\n' \
            '# ç½‘ç«™é•œåƒé…ç½®æŠ¥å‘Š' \
            "**ç”Ÿæˆæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M UTC')" \
            "**æºç«™ URL**: $TARGET_URL" \
            '**åˆè§„å£°æ˜**:' \
            '  - éµå®ˆ robots.txt è§„åˆ™' \
            "  - è¯·æ±‚é—´éš” ${WAIT_SECONDS} ç§’" \
            "  - User-Agent: $USER_AGENT" \
            '' \
            '## æ’é™¤è§„åˆ™' \
            '```' \
            "$REJECT_REGEX" \
            '```' \
            '' \
            '## è·¨åŸŸåŸŸå' \
            '```' \
            "$DOMAINS" \
            '```' \
            '' \
            '> æœ¬é•œåƒä»…ç”¨äºå­˜æ¡£/ç¦»çº¿æŸ¥é˜…ï¼Œè¯·éµå®ˆç›®æ ‡ç½‘ç«™ä½¿ç”¨æ¡æ¬¾ã€‚' \
            > "$MIRROR_DIR/MIRROR_CONFIG.md"
          
          # å¯¼å‡ºç»Ÿè®¡ä¿¡æ¯
          echo "MIRROR_DIR=$MIRROR_DIR" >> "$GITHUB_ENV"
          echo "FILE_COUNT=$(find \"$MIRROR_DIR\" -type f | wc -l)" >> "$GITHUB_ENV"
          echo "TOTAL_SIZE=$(du -sh \"$MIRROR_DIR\" | cut -f1)" >> "$GITHUB_ENV"

      - name: 'ğŸ“¤ ä¸Šä¼ ä¸º Artifact'
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'site-mirror-${{ github.run_id }}'
          path: '${{ env.MIRROR_DIR }}'
          retention-days: '${{ github.event.inputs.retention_days }}'

      - name: 'ğŸ“Š ä»»åŠ¡æ‘˜è¦'
        run: |
          echo "âœ… é•œåƒå®Œæˆ!"
          echo "ğŸ“ Artifact: site-mirror-${{ github.run_id }}"
          echo "ğŸ“¦ æ–‡ä»¶æ•°: ${{ env.FILE_COUNT }}"
          echo "ğŸ“Š å¤§å°: ${{ env.TOTAL_SIZE }}"
