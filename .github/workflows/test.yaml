name: test01

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'https://www.opendcl.com/HelpFiles/'
        required: true
        default: 'https://example.com/'
      wait_seconds:
        description: 'è¯·æ±‚é—´éš”ç§’æ•° (å»ºè®® â‰¥1ï¼Œéµå®ˆçˆ¬è™«ç¤¼ä»ª)'
        required: false
        default: '1'
      retention_days:
        description: 'Artifact ä¿ç•™å¤©æ•° (1-90)'
        required: false
        default: '30'
  # å–æ¶ˆæ³¨é‡Šå¯ç”¨å®šæ—¶ä»»åŠ¡ (ç¤ºä¾‹ï¼šæ¯å‘¨æ—¥å‡Œæ™¨ 2 ç‚¹ UTC)
  # schedule:
  #   - cron: '0 2 * * 0'

jobs:
  mirror:
    runs-on: ubuntu-22.04
    timeout-minutes: 90  # å¤§å‹ç½‘ç«™å»ºè®®æé«˜è¶…æ—¶

    steps:
      - name: ğŸ”§ å®‰è£… wget2
        run: |
          sudo apt-get update
          sudo apt-get install -y wget2 libnghttp2-14
          wget2 --version

      - name: ğŸŒ é•œåƒç½‘ç«™ (æ ¸å¿ƒé…ç½®åŒº)
        env:
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # â—ï¸ã€ä¿®æ”¹æ­¤å¤„ 1/4ã€‘ç›®æ ‡ç½‘ç«™åŸºç¡€é…ç½®
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          TARGET_URL: ${{ github.event.inputs.target_url }}  # é€šè¿‡ workflow_dispatch è¾“å…¥è¦†ç›–
          WAIT_SECONDS: ${{ github.event.inputs.wait_seconds }}
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # â—ï¸ã€ä¿®æ”¹æ­¤å¤„ 2/4ã€‘æ’é™¤è§„åˆ™ (æŒ‰éœ€è°ƒæ•´)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # ğŸ“Œ è¯´æ˜ï¼š
          #   - ä½¿ç”¨å•å¼•å·é¿å… YAML è½¬ä¹‰é—®é¢˜
          #   - æ­£åˆ™åŒ¹é… URL è·¯å¾„ç»“å°¾ (å«æŸ¥è¯¢å‚æ•°)
          #   - ä¿ç•™ç½‘é¡µå¿…éœ€èµ„æºï¼šHTML/CSS/JS/å›¾ç‰‡/å­—ä½“/JSON/XML
          # ğŸŒ° å¸¸è§åœºæ™¯ç¤ºä¾‹ (å–æ¶ˆå¯¹åº”è¡Œæ³¨é‡Šå¹¶åˆ é™¤å…¶ä»–è¡Œ)ï¼š
          #   Kotlin å®˜ç½‘: '\.(exe|dll|...|otf)(\?[^#]*)?$'  # (å½“å‰é…ç½®)
          #   æ–‡æ¡£ç«™ç²¾ç®€: '\.(mp4|avi|mov|zip|rar|7z|pdf|docx?|xlsx?)(\?[^#]*)?$'
          #   ä»…æ’é™¤å¤§æ–‡ä»¶: '\.(zip|rar|7z|tar|gz|iso|dmg|exe|msi|apk)(\?[^#]*)?$'
          #   ä¿ç•™ PDF:    '\.(exe|dll|zip|rar|7z|tar|gz|iso|dmg|msi|apk)(\?[^#]*)?$'  # ç§»é™¤ pdf
          REJECT_REGEX: '\.(exe|dll|so|bin|msi|dmg|pkg|deb|rpm|apk|app|img|sh|run|jar|cab|msu|mp[34]|avi|mov|wmv|flv|wav|ogg|webm|m4a|aac|mkv|zip|rar|7z|tar|gz|bz2|xz|tgz|iso|php|asp|jsp|cfm|pdf|docx?|xlsx?|pptx?|psd|ai|ttf|otf)(\?[^#]*)?$'
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # â—ï¸ã€ä¿®æ”¹æ­¤å¤„ 3/4ã€‘è·¨åŸŸèµ„æºåŸŸå (é€—å·åˆ†éš”)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # ğŸ“Œ è¯´æ˜ï¼š
          #   - ä»…å½“ç½‘ç«™èµ„æºåˆ†å¸ƒåœ¨å¤šä¸ªåŸŸåæ—¶éœ€è¦æ·»åŠ 
          #   - ç¤ºä¾‹ï¼š
          #       Kotlin: kotlinlang.org,resources.jetbrains.com,cdn.jsdelivr.net
          #       Hugo æ–‡æ¡£: hugo.io,themes.gohugo.io,cdn.jsdelivr.net
          #       ç•™ç©ºä»…æŠ“ä¸»ç«™: ${TARGET_DOMAIN}  (éœ€æ›¿æ¢ä¸ºå®é™…åŸŸå)
          DOMAINS: 'www.opendcl.com'
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # â—ï¸ã€ä¿®æ”¹æ­¤å¤„ 4/4ã€‘User-Agent (åˆè§„å¿…å¤‡)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # ğŸ“Œ è¯´æ˜ï¼š
          #   - å¿…é¡»åŒ…å«é¡¹ç›®æ ‡è¯†å’Œè”ç³»æ–¹å¼
          #   - å»ºè®®æ ¼å¼: "ProjectName/Version (+https://your-contact-url)"
          USER_AGENT: "SiteMirrorBot/1.0 (+https://github.com/${{ github.repository }})"
        run: |
          echo "ğŸš€ å¼€å§‹é•œåƒ: $TARGET_URL"
          echo "â±ï¸  è¯·æ±‚é—´éš”: ${WAIT_SECONDS}ç§’ | æ’é™¤è§„åˆ™: ${REJECT_REGEX:0:50}..."
          echo "ğŸŒ è·¨åŸŸåŸŸå: ${DOMAINS}"
          
          # åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„ç›®å½• (é¿å…è¦†ç›–)
          MIRROR_DIR="mirror-$(date +%Y%m%d-%H%M%S)"
          mkdir -p "$MIRROR_DIR"
          
          # æ‰§è¡Œé•œåƒ (å…³é”®: --quiet å‡å°‘æ—¥å¿—ï¼Œé”™è¯¯ä»ä¼šæ˜¾ç¤º)
          wget2 \
            --mirror \
            --page-requisites \
            --convert-links \
            --adjust-extension \
            --span-hosts \
            --domains="$DOMAINS" \
            --ignore-case \
            --reject-regex="$REJECT_REGEX" \
            --wait="$WAIT_SECONDS" \
            --user-agent="$USER_AGENT" \
            --directory-prefix="$MIRROR_DIR" \
            --quiet \
            "$TARGET_URL" || echo "âš ï¸ é•œåƒå®Œæˆ (å«è­¦å‘Šï¼Œå¯èƒ½å— robots.txt é™åˆ¶)"
          
          # ç”Ÿæˆé…ç½®æŠ¥å‘Š (å­˜å…¥é•œåƒç›®å½•ï¼Œéš Artifact ä¿å­˜)
          cat > "$MIRROR_DIR/MIRROR_CONFIG.md" <<'REPORT_EOF'
# ç½‘ç«™é•œåƒé…ç½®æŠ¥å‘Š
**ç”Ÿæˆæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M UTC')  
**æºç«™ URL**: $TARGET_URL  
**åˆè§„å£°æ˜**: 
- éµå®ˆ robots.txt è§„åˆ™
- è¯·æ±‚é—´éš” ${WAIT_SECONDS} ç§’
- User-Agent: $USER_AGENT

## æ’é™¤è§„åˆ™
\`\`\`
$REJECT_REGEX
\`\`\`

## è·¨åŸŸåŸŸå
\`\`\`
$DOMAINS
\`\`\`

> æœ¬é•œåƒä»…ç”¨äºå­˜æ¡£/ç¦»çº¿æŸ¥é˜…ï¼Œè¯·éµå®ˆç›®æ ‡ç½‘ç«™ä½¿ç”¨æ¡æ¬¾ã€‚
REPORT_EOF
          
          # ç»Ÿè®¡å¹¶å¯¼å‡ºç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "MIRROR_DIR=$MIRROR_DIR" >> $GITHUB_ENV
          echo "FILE_COUNT=$(find \"$MIRROR_DIR\" -type f | wc -l)" >> $GITHUB_ENV
          echo "TOTAL_SIZE=$(du -sh \"$MIRROR_DIR\" 2>/dev/null | cut -f1)" >> $GITHUB_ENV

      - name: ğŸ“¤ ä¸Šä¼ ä¸º Artifact
        uses: actions/upload-artifact@v4
        with:
          name: site-mirror-${{ github.run_id }}
          path: ${{ env.MIRROR_DIR }}
          retention-days: ${{ github.event.inputs.retention_days || 30 }}
          # compression-level: 6  # å¦‚éœ€åŠ é€Ÿä¸Šä¼ å¯å–æ¶ˆæ³¨é‡Š (0-9)

      - name: ğŸ“Š ä»»åŠ¡æ‘˜è¦
        run: |
          echo "âœ… é•œåƒä»»åŠ¡å®Œæˆ!"
          echo "ğŸ“ Artifact åç§°: site-mirror-${{ github.run_id }}"
          echo "ğŸ“¦ æ–‡ä»¶æ•°é‡: ${{ env.FILE_COUNT }}"
          echo "ğŸ“Š æ€»å¤§å°: ${{ env.TOTAL_SIZE }}"
          echo "ğŸ”— ä¸‹è½½è·¯å¾„: Actions â†’ æœ¬æ¬¡è¿è¡Œ â†’ Artifacts"
          echo ""
          echo "ğŸ’¡ æç¤º:"
          echo "  1. å¦‚éœ€éƒ¨ç½²åˆ° GitHub Pagesï¼Œå‚è€ƒ: https://docs.github.com/en/pages"
          echo "  2. è°ƒæ•´æ’é™¤è§„åˆ™è¯·ä¿®æ”¹å·¥ä½œæµä¸­ 'ã€ä¿®æ”¹æ­¤å¤„ 2/4ã€‘' éƒ¨åˆ†"
          echo "  3. æ£€æŸ¥ MIRROR_CONFIG.md äº†è§£æœ¬æ¬¡é•œåƒé…ç½®ç»†èŠ‚"
