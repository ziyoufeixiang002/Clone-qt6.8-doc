name: Clone-nodejs-doc

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼ˆæ¨èï¼šé¿å…å®šæ—¶ä»»åŠ¡é€ æˆæœåŠ¡å™¨å‹åŠ›ï¼‰
  # schedule:
  #   - cron: '0 2 * * 0'  # å¦‚éœ€æ¯å‘¨æ—¥ 2 ç‚¹è‡ªåŠ¨æ›´æ–°ï¼Œå–æ¶ˆæ³¨é‡Šï¼ˆè¯·å…ˆç¡®è®¤éµå®ˆ robots.txtï¼‰

jobs:
  clone-qt-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    env:
      TARGET_URL: "https://nodejs.org/docs/latest/api/"
      DOWNLOAD_DIR: "android-doc"
    
    steps:
      - name: ğŸ› ï¸ Setup Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y wget ca-certificates
          mkdir -p $DOWNLOAD_DIR

      - name: ğŸŒ Download Documentation (Smart Filtering)
        run: |
          wget \
            --recursive \
            --level=10 \
            --no-clobber \
            --page-requisites \
            --convert-links \
            --html-extension \
            --restrict-file-names=ascii \
            --domains=nodejs.org \
            --no-parent \
            --wait=0.5 \
            --random-wait \
            --timeout=20 \
            --tries=2 \
            --user-agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
            --reject-regex '\.(mp[34]|avi|mov|wmv|flv|webm|wav|ogg|zip|rar|tar|gz|bz2|xz|7z|iso|dmg|exe|msi|apk|bin|deb|rpm|pdf)$' \
            --accept-regex '\.(html?|css|js|txt|md|json|xml|svg|png|jpg|jpeg|gif|ico|woff2?|eot|ttf|otf)$' \
            --directory-prefix=$DOWNLOAD_DIR \
            $TARGET_URL
        continue-on-error: true  # å®¹å¿ä¸ªåˆ«èµ„æºå¤±è´¥ï¼ˆå¦‚403/404ï¼‰ï¼Œä¿è¯ä¸»æµç¨‹å®Œæˆ

      - name: ğŸ“¦ Package & Upload Artifact
        run: |
          # æ¸…ç†æ— ç”¨ä¸´æ—¶æ–‡ä»¶ï¼ˆwgetç”Ÿæˆçš„queryå‚æ•°æ–‡ä»¶ç­‰ï¼‰
          find $DOWNLOAD_DIR -type f -name "*\?*" -delete 2>/dev/null || true
          tar -I 'zstd -T0 --long' -cf android-doc.zst $DOWNLOAD_DIR
        shell: bash

      - name: ğŸ“¤ Upload to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-doc
          path: android-doc.zst
          retention-days: 14
          compression-level: 0  # å·²é¢„å‹ç¼©ï¼Œè·³è¿‡äºŒæ¬¡å‹ç¼©æé€Ÿ

      - name: ğŸ§¹ Cleanup Workspace
        run: rm -rf $DOWNLOAD_DIR qt-docs.zst
        if: always()
